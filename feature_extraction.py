import os
from os.path import isfile,join
import binascii
import re
import csv


dir='C:/Users/sze/FYP/Malware Dataset/'
family=['adware','crypto_miner','spyware','file_infector','worm','downloader','ransomware','installer','dropper','packed','flooder']
full_dir=[]

call=0 #opcode:e8
jmp=0  #opcode:c3,cb
ret=0  #opcode:eb,e9

for i in range(len(family)):
    d=[dir]
    d.append(family[i])
    d.append('/')
    full_dir.append("".join(d))

data=open('C:/Users/sze/FYP/features.csv','w',newline='') ##create csv file
writer=csv.writer(data)
writer.writerow(["File","Family","JMP","CALL","RET","No_of_Terms"])

for i in range(len(family)):
    files={}
    for f_name in os.listdir(full_dir[i]):
        filename=full_dir[i]+f_name
        if(isfile(filename)):
            f=open(filename,'r+b')
            files[f_name]=binascii.hexlify(f.read(),'-')
   
    for f_name,text in files.items():
        n_of_terms=(len(text)-len(re.findall("-",str(text))))//2
        call+=len(re.findall("e8",str(text)))
        ret+=len(re.findall("c3",str(text)))
        ret+=len(re.findall("cb",str(text)))
        jmp+=len(re.findall('eb',str(text)))
        jmp+=len(re.findall('e9',str(text)))
        writer.writerow([f_name,family[i],jmp,call,ret,n_of_terms])
        call=0
        ret=0
        jmp=0
        


