import os
from os.path import isfile,join
import binascii
import re
import csv
from capstone import *

dir='C:/Users/sze/FYP/Malware Dataset/'
family=['adware','crypto_miner','spyware','file_infector','worm','downloader','ransomware','installer','dropper','packed','flooder']
full_dir=[]

call=0 #opcode:e8
jmp=0  #opcode:c3,cb
ret=0  #opcode:eb,e9
n_of_terms=0
for i in range(len(family)):
    d=[dir]
    d.append(family[i])
    d.append('/')
    full_dir.append("".join(d))

data=open('C:/Users/sze/FYP/features_asm.csv','w',newline='') ##create csv file
writer=csv.writer(data)
writer.writerow(["File","Family","JMP","CALL","RET","No_of_Terms"])
md = Cs(CS_ARCH_X86, CS_MODE_64)

for i in range(len(family)):
    files={}
    for f_name in os.listdir(full_dir[i]):
        filename=full_dir[i]+f_name
        if(isfile(filename)):
            f=open(filename,'r+b')
            files[f_name]=(f.read())
   
    for f_name,code in files.items():
        for instruction in md.disasm(code, 0x00):
            text=("%s" %(instruction.mnemonic))
            n_of_terms+=1
            call+=len(re.findall("call",str(text)))
            ret+=len(re.findall("ret",str(text)))
            jmp+=len(re.findall('jmp',str(text)))
        writer.writerow([f_name,family[i],jmp,call,ret,n_of_terms])
        call=0
        ret=0
        jmp=0
        n_of_terms=0

